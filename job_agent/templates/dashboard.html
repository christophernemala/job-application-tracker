<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Job Agent Dashboard</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’¼</text></svg>">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
    .header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-bottom: 1px solid rgba(255,255,255,0.1); padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 22px; font-weight: 700; color: #fff; }
    .header h1 span { color: #60a5fa; }
    .header-actions { display: flex; gap: 12px; align-items: center; }
    .header-actions .user-info { color: rgba(255,255,255,0.6); font-size: 14px; }
    .btn-sm { padding: 8px 16px; border-radius: 8px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; }
    .btn-primary { background: linear-gradient(135deg, #3b82f6, #6366f1); color: #fff; }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-danger { background: rgba(239,68,68,0.15); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }
    .btn-danger:hover { background: rgba(239,68,68,0.25); }
    main { max-width: 1100px; margin: 0 auto; padding: 32px 24px; }
    .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 32px; }
    .stat-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 20px; }
    .stat-card .label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: rgba(255,255,255,0.5); margin-bottom: 4px; }
    .stat-card .value { font-size: 28px; font-weight: 700; color: #fff; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .section-header h2 { font-size: 18px; font-weight: 600; color: #fff; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    .application-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s ease; }
    .application-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.3); border-color: rgba(99,102,241,0.4); }
    .application-card h3 { font-size: 16px; font-weight: 600; color: #fff; margin-bottom: 6px; }
    .application-card .company { color: #60a5fa; font-size: 14px; margin-bottom: 8px; }
    .application-card .meta { display: flex; justify-content: space-between; align-items: center; }
    .application-card .meta small { color: rgba(255,255,255,0.5); font-size: 12px; }
    .status-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .status-applied { background: rgba(59,130,246,0.2); color: #60a5fa; }
    .status-interview { background: rgba(245,158,11,0.2); color: #fbbf24; }
    .status-offered { background: rgba(34,197,94,0.2); color: #4ade80; }
    .status-rejected { background: rgba(239,68,68,0.2); color: #f87171; }
    .empty-state { text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.4); }
    .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
    .empty-state p { font-size: 15px; margin-bottom: 20px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
    .modal-content { background: #1e293b; margin: 4% auto; padding: 32px; border-radius: 16px; width: 90%; max-width: 700px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px rgba(0,0,0,0.5); max-height: 85vh; overflow-y: auto; }
    .modal-content h2 { color: #fff; margin-bottom: 20px; font-size: 20px; }
    .close { float: right; cursor: pointer; font-size: 24px; color: rgba(255,255,255,0.5); background: none; border: none; }
    .close:hover { color: #fff; }
    .details-section { margin: 16px 0; padding: 16px; border-left: 3px solid #6366f1; background: rgba(255,255,255,0.03); border-radius: 0 8px 8px 0; }
    .details-section h3 { font-size: 14px; color: #60a5fa; margin-bottom: 8px; }
    .details-section p { font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 4px; }
    .cover-letter-text { background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; font-size: 14px; color: rgba(255,255,255,0.8); }
    textarea { width: 100%; padding: 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; color: #fff; font-size: 14px; resize: vertical; }
    textarea:focus { outline: none; border-color: #6366f1; }
    .add-form { display: none; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 24px; margin-bottom: 24px; }
    .add-form.active { display: block; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: rgba(255,255,255,0.6); margin-bottom: 6px; }
    .form-group input, .form-group select { width: 100%; padding: 10px 14px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; color: #fff; font-size: 14px; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #6366f1; }
    .form-group select option { background: #1e293b; color: #fff; }
    .form-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 8px; }
    .btn-cancel { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; }
    .btn-link { display: inline-block; padding: 6px 12px; color: #fff; background: #6366f1; border-radius: 6px; text-decoration: none; font-size: 13px; }
    .btn-link:hover { opacity: 0.9; }
    .btn-save-notes { margin-top: 8px; padding: 6px 14px; background: #6366f1; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; }
    @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } .header { padding: 12px 16px; } main { padding: 20px 12px; } }
  </style>
</head>
<body>
  <div class="header">
    <h1>&#x1F4BC; Job <span>Tracker</span></h1>
    <div class="header-actions">
      <span class="user-info">Welcome, {{ session.get('username', 'User') }}</span>
      <a href="/logout" class="btn-sm btn-danger">Logout</a>
    </div>
  </div>
  <main>
    <div class="stats-bar">
      <div class="stat-card">
        <div class="label">Total Applications</div>
        <div class="value">{{ applications|length }}</div>
      </div>
      <div class="stat-card">
        <div class="label">Platforms</div>
        <div class="value">{{ applications|map(attribute='platform')|unique|list|length }}</div>
      </div>
      <div class="stat-card">
        <div class="label">Avg Match Score</div>
        <div class="value">
          {% set scores = applications|selectattr('match_score')|map(attribute='match_score')|list %}
          {% if scores %}{{ (scores|sum / scores|length)|round|int }}%{% else %}N/A{% endif %}
        </div>
      </div>
    </div>

    <div class="section-header">
      <h2>Applications</h2>
      <button class="btn-sm btn-primary" onclick="toggleAddForm()">+ Add Application</button>
    </div>

    <div class="add-form" id="addForm">
      <h3 style="color:#fff; margin-bottom:16px;">Add New Application</h3>
      <form id="newAppForm" onsubmit="submitApplication(event)">
        <div class="form-grid">
          <div class="form-group">
            <label>Job Title *</label>
            <input type="text" name="job_title" required placeholder="e.g. Senior AR Executive">
          </div>
          <div class="form-group">
            <label>Company *</label>
            <input type="text" name="company" required placeholder="e.g. Emirates NBD">
          </div>
          <div class="form-group">
            <label>Platform *</label>
            <select name="platform">
              <option value="LinkedIn">LinkedIn</option>
              <option value="Naukri Gulf">Naukri Gulf</option>
              <option value="Indeed">Indeed</option>
              <option value="Bayt">Bayt</option>
              <option value="GulfTalent">GulfTalent</option>
              <option value="Company Website">Company Website</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select name="status">
              <option value="applied">Applied</option>
              <option value="interview">Interview</option>
              <option value="offered">Offered</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
          <div class="form-group">
            <label>Job URL</label>
            <input type="url" name="job_url" placeholder="https://...">
          </div>
          <div class="form-group">
            <label>Match Score (%)</label>
            <input type="number" name="match_score" min="0" max="100" placeholder="85">
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn-cancel" onclick="toggleAddForm()">Cancel</button>
          <button type="submit" class="btn-sm btn-primary">Save Application</button>
        </div>
      </form>
    </div>

    <section class="grid">
      {% for app in applications %}
      <article class="application-card" data-app-id="{{ app.id }}" onclick="showApplicationDetails({{ app.id }})">
        <h3>{{ app.job_title }}</h3>
        <p class="company">{{ app.company }}</p>
        <div class="meta">
          <small>{{ app.platform }}</small>
          <span class="status-badge status-{{ app.status or 'applied' }}">{{ app.status or 'applied' }}</span>
        </div>
        {% if app.match_score %}
        <div style="margin-top:8px;">
          <div style="background:rgba(255,255,255,0.1);border-radius:4px;height:6px;overflow:hidden;">
            <div style="background:linear-gradient(90deg,#3b82f6,#6366f1);height:100%;width:{{ app.match_score }}%;border-radius:4px;"></div>
          </div>
          <small style="color:rgba(255,255,255,0.4);">Match: {{ app.match_score }}%</small>
        </div>
        {% endif %}
      </article>
      {% else %}
      <div class="empty-state" style="grid-column: 1 / -1;">
        <div class="icon">&#x1F4CB;</div>
        <p>No applications yet. Click <strong>+ Add Application</strong> above to get started!</p>
      </div>
      {% endfor %}
    </section>
  </main>

  <script>
    function escapeHtml(str) {
      if (str == null) return '';
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }

    function toggleAddForm() {
      document.getElementById('addForm').classList.toggle('active');
    }

    function submitApplication(e) {
      e.preventDefault();
      var form = e.target;
      var data = {
        job_title: form.job_title.value,
        company: form.company.value,
        platform: form.platform.value,
        status: form.status.value,
        job_url: form.job_url.value || '',
        match_score: form.match_score.value ? parseInt(form.match_score.value) : null
      };
      fetch('/api/applications', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(function(r) { return r.json(); })
      .then(function() { window.location.reload(); })
      .catch(function(err) { alert('Error: ' + err.message); });
    }

    function showApplicationDetails(appId) {
      fetch('/api/application/' + appId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          var modal = document.createElement('div');
          modal.className = 'modal';
          modal.innerHTML =
            '<div class="modal-content">' +
              '<button class="close" onclick="this.closest(\'.modal\').remove()">&times;</button>' +
              '<h2>' + escapeHtml(data.job_title) + ' &mdash; ' + escapeHtml(data.company) + '</h2>' +
              '<div class="details-section">' +
                '<h3>Application Info</h3>' +
                '<p><strong>Platform:</strong> ' + escapeHtml(data.platform) + '</p>' +
                '<p><strong>Applied:</strong> ' + (data.applied_date ? new Date(data.applied_date).toLocaleDateString() : 'N/A') + '</p>' +
                '<p><strong>Status:</strong> <span class="status-badge status-' + escapeHtml(data.status || 'applied') + '">' + escapeHtml(data.status || 'applied') + '</span></p>' +
                '<p><strong>Match Score:</strong> ' + (data.match_score != null ? data.match_score + '%' : 'N/A') + '</p>' +
              '</div>' +
              (data.cover_letter ? '<div class="details-section"><h3>Cover Letter</h3><div class="cover-letter-text">' + escapeHtml(data.cover_letter) + '</div></div>' : '') +
              '<div class="details-section">' +
                '<h3>Actions</h3>' +
                (data.job_url ? '<a href="' + escapeHtml(data.job_url) + '" target="_blank" class="btn-link">View Job Posting</a>' : '<p>No job URL available</p>') +
              '</div>' +
              '<div class="details-section">' +
                '<h3>Notes</h3>' +
                '<textarea id="notes-' + data.id + '" rows="3" placeholder="Add notes...">' + escapeHtml(data.notes) + '</textarea>' +
                '<button class="btn-save-notes" onclick="saveNotes(' + data.id + ')">Save Notes</button>' +
              '</div>' +
            '</div>';
          document.body.appendChild(modal);
          modal.style.display = 'block';
          modal.addEventListener('click', function(e) { if (e.target === modal) modal.remove(); });
        });
    }

    function saveNotes(appId) {
      var notes = document.getElementById('notes-' + appId).value;
      fetch('/api/application/' + appId + '/notes', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes: notes })
      }).then(function() {
        alert('Notes saved!');
      });
    }
  </script>
</body>
</html>
